<div class="stock-container" *ngIf="quote; else loadingOrError">
    <h2>{{ companyName }} ({{ ticker }})</h2>
    <table class="quote-table">
        <tr>
          <td>
            Open <app-info [text]="definitions.open"></app-info>
          </td>
          <td>$ {{ quote['02. open'] | number:'1.2-2' }}</td>
        </tr>
      
        <tr>
          <td>
            High <app-info [text]="definitions.high"></app-info>
          </td>
          <td>$ {{ quote['03. high'] | number:'1.2-2' }}</td>
        </tr>
      
        <tr>
          <td>
            Low <app-info [text]="definitions.low"></app-info>
          </td>
          <td>$ {{ quote['04. low'] | number:'1.2-2' }}</td>
        </tr>
      
        <tr>
          <td>
            Price <app-info [text]="definitions.price"></app-info>
          </td>
          <td>$ {{ quote['05. price'] | number:'1.2-2' }}</td>
        </tr>
      
        <tr>
          <td>
            Previous Close <app-info [text]="definitions.previousClose"></app-info>
          </td>
          <td>$ {{ quote['08. previous close'] | number:'1.2-2' }}</td>
        </tr>
      
        <tr>
          <td>
            Change <app-info [text]="definitions.change"></app-info>
          </td>
          <td [ngClass]="{'positive': quote['09. change'] >= 0, 'negative': quote['09. change'] < 0}">
            $ {{ quote['09. change'] | number:'1.2-2' }}
          </td>
        </tr>
      
        <tr>
          <td>
            Change % <app-info [text]="definitions.changePercent"></app-info>
          </td>
          <td [ngClass]="{'positive': isPositive(quote['10. change percent']), 'negative': !isPositive(quote['10. change percent'])}">
            {{ quote['10. change percent'] }}
          </td>
        </tr>
      
        <tr>
          <td>
            Volume <app-info [text]="definitions.volume"></app-info>
          </td>
          <td>{{ quote['06. volume'] | number }}</td>
        </tr>
      
        <tr>
          <td>
            Latest Trading Day <app-info [text]="definitions.latestTradingDay"></app-info>
          </td>
          <td>{{ quote['07. latest trading day'] }}</td>
        </tr>
      </table>      
  </div>

  <section class="add-to-list card" *ngIf="ticker && lists?.length">
    <h3>Add {{ ticker }} to a list</h3>
  
    <div class="atl-row">
      <label for="listSelect">List</label>
      <select
        id="listSelect"
        [(ngModel)]="selectedListId"
        (change)="clearAddListStates()">
        <option *ngFor="let l of lists" [value]="l._id">
          {{ l.name }} <ng-container *ngIf="l.myStocks">• My Stocks</ng-container>
        </option>
      </select>
  
      <button
        type="button"
        class="btn btn-primary"
        (click)="addTickerToSelectedList()"
        [disabled]="addingToList || !selectedListId">
        <ng-container *ngIf="!addingToList">Add</ng-container>
        <span *ngIf="addingToList" class="spinner" aria-hidden="true"></span>
      </button>
  
      <!-- Optional quick add to “My Stocks” -->
      <button
        type="button"
        class="btn"
        (click)="quickAddToMyStocks()"
        [disabled]="addingToList || !myStocksId">
        Quick add to My Stocks
      </button>
    </div>
  
    <p class="result success" *ngIf="addListSuccess">{{ addListSuccess }}</p>
    <p class="result error" *ngIf="addListError">{{ addListError }}</p>
  </section>
  

  <!-- Make a Prediction (for this ticker) -->
<section class="pred-create-card" *ngIf="ticker">
  <header class="pred-create-header">
    <h3>Make a Prediction for <span class="ticker-pill">{{ ticker }}</span></h3>
  </header>

  <form (ngSubmit)="submitPredictionForTicker(predForm)" #predForm="ngForm" novalidate>
    <div class="grid">
      <!-- Ticker (read-only display) -->
      <div class="field readonly">
        <label>Ticker</label>
        <div class="readonly-box">{{ ticker }}</div>
      </div>

      <!-- Model Type -->
      <div class="field">
        <label for="modelType">Model Type
          <app-info [text]="definitions.modelType"></app-info>
        </label>
        <select
          id="modelType"
          name="modelType"
          [(ngModel)]="modelType"
          required
          #modelCtrl="ngModel"
        >
          <option value="lstm">LSTM</option>
          <option value="gru">GRU</option>
          <option value="rnn">RNN</option>
        </select>
        <small class="error" *ngIf="modelCtrl.invalid && (modelCtrl.dirty || modelCtrl.touched)">
          Choose a model type.
        </small>
      </div>
      <div class="use-sector" *ngIf="showSector">
        <input
          type="checkbox"
          id="useSector"
          name="useSectorCheckbox"
          [(ngModel)]="useSector"
          class="toggle-input"
        />
        <label for="useSector" class="toggle-label">
          <span class="toggle-track" aria-hidden="true">
            <span class="toggle-thumb"></span>
          </span>
          <span class="toggle-text">Use model trained specifically on {{ sectorName }} sector</span>
        </label>

        <ng-container *ngIf="sectors.length > 1; else singleSector">
          <label for="sectorSelect">Sector:</label>
          <select id="sectorSelect"
                  [(ngModel)]="sectorName"
                  (ngModelChange)="onSectorChange($event)">
            <option *ngFor="let s of sectors" [ngValue]="s.name">{{ s.name }}</option>
          </select>
        </ng-container>
      
        <!-- Show the single sector as text if there's only one -->
        <ng-template #singleSector>
          <span class="sector-pill" *ngIf="sectors.length">{{ sectors[0].name }}</span>
        </ng-template>
      </div>

      <!-- Timeline -->
      <div class="field">
        <label for="predictionTimeline">Prediction Length
          <app-info [text]="definitions.predictionTimeline"></app-info>
        </label>
        <select
          id="predictionTimeline"
          name="predictionTimeline"
          [(ngModel)]="predictionTimeline"
          required
          #timelineCtrl="ngModel"
        >
          <option value="1d">1 Day</option>
          <option value="2w">2 Weeks</option>
          <option value="2m">2 Months</option>
        </select>
        <small class="error" *ngIf="timelineCtrl.invalid && (timelineCtrl.dirty || timelineCtrl.touched)">
          Choose a length.
        </small>
      </div>
    </div>

    <div class="actions">
      <button type="submit" [disabled]="predForm.invalid || submitting">
        <ng-container *ngIf="!submitting; else spinner">Predict</ng-container>
      </button>
      <ng-template #spinner>
        <span class="spinner"></span> Predicting…
      </ng-template>
    </div>

    <!-- Inline result -->
    <p class="result success" *ngIf="createSuccess">
      ✅ Prediction created{{ createdPredictionPrice ? (': $' + (createdPredictionPrice | number:'1.2-2')) : '' }}.
    </p>
    <p class="result error" *ngIf="createError">{{ createError }}</p>
  </form>
</section>


  <div class="tf-bar">
    <label for="timeframe">Timeframe</label>
    <select
      id="timeframe"
      [(ngModel)]="selectedTimeframe"
      (change)="updateTimeframe()"
      class="tf-select"
    >
      <option *ngFor="let tf of timeframes" [value]="tf">{{ tf }}</option>
    </select>
    <span class="tf-meta loading" *ngIf="seriesLoading">Loading series…</span>
    <span class="tf-meta error" *ngIf="seriesError">{{ seriesError }}</span>
  </div>

  <!-- <div class="plot-controls" *ngIf="predictionGroups?.length || series?.length">
    <label class="control">
      <input type="checkbox" [(ngModel)]="selectedActual" (change)="updateChart()" />
      Show actual price
    </label>
  
    <div class="group-controls">
      <div class="group" *ngFor="let g of predictionGroups">
        <label>
          <input
            type="checkbox"
            [(ngModel)]="selectedKeys[keyOf(g)]"
            (change)="updateChart()"
          />
          {{ g.modelType.toUpperCase() }} • {{ g.timeframe }}, {{ g.sector}} ({{ g.items.length }})
        </label>
      </div>
    </div>
  </div> -->
  
  <div class="chart-wrap">
    <canvas #comboChart></canvas>
  </div>
  
  <section *ngIf="predictionsLoading" class="pred-list-wrap">
    Loading {{ ticker }} predictions…
  </section>
  
  <section *ngIf="!predictionsLoading && !predictionsError" class="pred-list-wrap">
    <h3>Predictions for {{ ticker }}</h3>
    <app-prediction-list [predictions]="predictions"></app-prediction-list>
  </section>
  
  <section *ngIf="!predictionsLoading && predictionsError" class="pred-list-wrap error">
    {{ predictionsError }}
  </section>

  <button class="predictions-button" (click)="navigateToPredictions()">
    Go To Your Predictions
  </button>

  
  <ng-template #loadingOrError>
    <div *ngIf="errorMessage" class="error">{{ errorMessage }}</div>
    <div *ngIf="!errorMessage">Loading stock data...</div>
  </ng-template>

  
  